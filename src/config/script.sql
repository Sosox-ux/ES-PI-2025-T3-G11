--------------------------------------------------------
-- 1. CRIAÇÃO DAS TABELAS
--------------------------------------------------------

CREATE TABLE DOCENTE (
    ID_DOCENTE NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NOME VARCHAR2(255) NOT NULL,
    EMAIL VARCHAR2(255) NOT NULL UNIQUE,
    TELEFONE_CELULAR VARCHAR2(20),
    SENHA_HASH VARCHAR2(255) NOT NULL,
    RESET_CODE VARCHAR2(10),
    RESET_EXPIRES_AT TIMESTAMP
);

CREATE TABLE INSTITUICAO (
    ID_INSTITUICAO NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NOME VARCHAR2(255) NOT NULL,
    LOCAL VARCHAR2(30),
    FK_ID_DOCENTE NUMBER NOT NULL
);

CREATE TABLE DISCIPLINA (
    ID_DISCIPLINA NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NOME VARCHAR2(255) NOT NULL,
    SIGLA VARCHAR2(20),
    CODIGO VARCHAR2(50),
    PERIODO_CURSO VARCHAR2(100),
    FK_ID_DOCENTE NUMBER,
    TIPO_MEDIA VARCHAR2(1) DEFAULT 'A'
);

CREATE TABLE TURMA (
    ID_TURMA NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NOME VARCHAR2(100) NOT NULL,
    CODIGO VARCHAR2(50),
    APELIDO VARCHAR2(100),
    FK_ID_DISCIPLINA NUMBER NOT NULL,
    FK_ID_INSTITUICAO NUMBER NOT NULL
);

CREATE TABLE ALUNO (
    ID_ALUNO NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    MATRICULA VARCHAR2(100) NOT NULL,
    NOME_COMPLETO VARCHAR2(255) NOT NULL,
    FK_ID_DOCENTE NUMBER NOT NULL,
    FK_ID_INSTITUICAO NUMBER
);

CREATE TABLE INSCRICAO (
    ID_INSCRICAO NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    FK_ID_ALUNO NUMBER NOT NULL,
    FK_ID_TURMA NUMBER NOT NULL
);

CREATE TABLE COMPONENTE_NOTA (
    ID_COMPONENTE NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NOME VARCHAR2(255) NOT NULL,
    SIGLA VARCHAR2(20),
    DESCRICAO VARCHAR2(1000),
    PESO NUMBER(3,2) DEFAULT 1.00,
    FK_ID_DISCIPLINA NUMBER NOT NULL
);

CREATE TABLE NOTA (
    ID_NOTA NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    FK_ID_INSCRICAO NUMBER NOT NULL,
    FK_ID_COMPONENTE NUMBER NOT NULL,
    VALOR_NOTA NUMBER(4,2),
    CONSTRAINT CHK_VALOR_NOTA CHECK (VALOR_NOTA >= 0.00 AND VALOR_NOTA <= 10.00)
);

CREATE TABLE LOG_AUDITORIA_NOTAS (
    ID_LOG NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    FK_ID_NOTA NUMBER NOT NULL,
    VALOR_ANTIGO NUMBER(4,2),
    VALOR_NOVO NUMBER(4,2),
    OPERACAO VARCHAR2(10) NOT NULL,
    DATA_HORA TIMESTAMP DEFAULT SYSTIMESTAMP NOT NULL,
    FK_ID_DOCENTE_OPERACAO NUMBER,
    NOME_ALUNO VARCHAR2(255)
);

--------------------------------------------------------
-- 2. CONSTRAINTS (CHAVES ESTRANGEIRAS E UNICIDADE)
--------------------------------------------------------

-- Unicidade
ALTER TABLE ALUNO ADD CONSTRAINT UQ_MATRICULA_INST UNIQUE (MATRICULA, FK_ID_INSTITUICAO);
ALTER TABLE INSCRICAO ADD CONSTRAINT UQ_ALUNO_TURMA UNIQUE (FK_ID_ALUNO, FK_ID_TURMA);
ALTER TABLE NOTA ADD CONSTRAINT UQ_INSCRICAO_COMPONENTE UNIQUE (FK_ID_INSCRICAO, FK_ID_COMPONENTE);

-- Foreign Keys: INSTITUICAO
ALTER TABLE INSTITUICAO ADD CONSTRAINT FK_DOCENTE_INST FOREIGN KEY (FK_ID_DOCENTE) REFERENCES DOCENTE (ID_DOCENTE) ON DELETE CASCADE;

-- Foreign Keys: DISCIPLINA
ALTER TABLE DISCIPLINA ADD CONSTRAINT FK_DISCIPLINA_DOCENTE FOREIGN KEY (FK_ID_DOCENTE) REFERENCES DOCENTE (ID_DOCENTE) ON DELETE SET NULL;

-- Foreign Keys: TURMA
ALTER TABLE TURMA ADD CONSTRAINT FK_DISC_TURMA FOREIGN KEY (FK_ID_DISCIPLINA) REFERENCES DISCIPLINA (ID_DISCIPLINA) ON DELETE CASCADE;
ALTER TABLE TURMA ADD CONSTRAINT FK_TURMA_INSTITUICAO FOREIGN KEY (FK_ID_INSTITUICAO) REFERENCES INSTITUICAO (ID_INSTITUICAO);

-- Foreign Keys: ALUNO
ALTER TABLE ALUNO ADD CONSTRAINT FK_INSTITUICAO_ALUNO FOREIGN KEY (FK_ID_INSTITUICAO) REFERENCES INSTITUICAO (ID_INSTITUICAO) ON DELETE CASCADE;

-- Foreign Keys: INSCRICAO
ALTER TABLE INSCRICAO ADD CONSTRAINT FK_ALUNO_INSC FOREIGN KEY (FK_ID_ALUNO) REFERENCES ALUNO (ID_ALUNO) ON DELETE CASCADE;
ALTER TABLE INSCRICAO ADD CONSTRAINT FK_TURMA_INSC FOREIGN KEY (FK_ID_TURMA) REFERENCES TURMA (ID_TURMA) ON DELETE CASCADE;

-- Foreign Keys: COMPONENTE_NOTA
ALTER TABLE COMPONENTE_NOTA ADD CONSTRAINT FK_DISC_COMP FOREIGN KEY (FK_ID_DISCIPLINA) REFERENCES DISCIPLINA (ID_DISCIPLINA) ON DELETE CASCADE;

-- Foreign Keys: NOTA
ALTER TABLE NOTA ADD CONSTRAINT FK_COMP_NOTA FOREIGN KEY (FK_ID_COMPONENTE) REFERENCES COMPONENTE_NOTA (ID_COMPONENTE) ON DELETE CASCADE;
ALTER TABLE NOTA ADD CONSTRAINT FK_INSC_NOTA FOREIGN KEY (FK_ID_INSCRICAO) REFERENCES INSCRICAO (ID_INSCRICAO) ON DELETE CASCADE;

-- Foreign Keys: LOG_AUDITORIA
ALTER TABLE LOG_AUDITORIA_NOTAS ADD CONSTRAINT FK_DOCENTE_LOG FOREIGN KEY (FK_ID_DOCENTE_OPERACAO) REFERENCES DOCENTE (ID_DOCENTE) ON DELETE SET NULL;
ALTER TABLE LOG_AUDITORIA_NOTAS ADD CONSTRAINT FK_NOTA_LOG FOREIGN KEY (FK_ID_NOTA) REFERENCES NOTA (ID_NOTA) ON DELETE CASCADE;

--------------------------------------------------------
-- 3. TRIGGER DE AUDITORIA
--------------------------------------------------------

CREATE OR REPLACE TRIGGER TRG_AUDITORIA_NOTAS
AFTER INSERT OR UPDATE ON NOTA
FOR EACH ROW
DECLARE
    v_id_docente NUMBER;
    v_nome_aluno VARCHAR2(255);
BEGIN
    BEGIN
        SELECT
            d.FK_ID_DOCENTE,
            a.NOME_COMPLETO
        INTO
            v_id_docente,
            v_nome_aluno
        FROM INSCRICAO insc
        JOIN ALUNO a ON insc.FK_ID_ALUNO = a.ID_ALUNO
        JOIN TURMA t ON insc.FK_ID_TURMA = t.ID_TURMA
        JOIN DISCIPLINA d ON t.FK_ID_DISCIPLINA = d.ID_DISCIPLINA
        WHERE insc.ID_INSCRICAO = :new.FK_ID_INSCRICAO;

    EXCEPTION
        WHEN NO_DATA_FOUND THEN
            v_id_docente := NULL;
            v_nome_aluno := 'Aluno não encontrado';
    END;

    IF INSERTING THEN
        INSERT INTO LOG_AUDITORIA_NOTAS
            (FK_ID_NOTA, VALOR_ANTIGO, VALOR_NOVO, OPERACAO, DATA_HORA, FK_ID_DOCENTE_OPERACAO, NOME_ALUNO)
        VALUES
            (:new.ID_NOTA, NULL, :new.VALOR_NOTA, 'INSERT', SYSTIMESTAMP, v_id_docente, v_nome_aluno);

    ELSIF UPDATING THEN
        INSERT INTO LOG_AUDITORIA_NOTAS
            (FK_ID_NOTA, VALOR_ANTIGO, VALOR_NOVO, OPERACAO, DATA_HORA, FK_ID_DOCENTE_OPERACAO, NOME_ALUNO)
        VALUES
            (:new.ID_NOTA, :old.VALOR_NOTA, :new.VALOR_NOTA, 'UPDATE', SYSTIMESTAMP, v_id_docente, v_nome_aluno);
    END IF;
END;
/